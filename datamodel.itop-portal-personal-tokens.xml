<?xml version="1.0" encoding="UTF-8"?>
<itop_design xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" version="3.1">
  <user_rights>
    <profiles>
      <!-- Extend Portal User profile to allow PersonalToken management -->
      <profile id="2" _delta="must_exist">
        <groups>
          <group id="PersonalToken" _delta="define">
            <actions>
              <action id="action:read">allow</action>
              <action id="action:write">allow</action>
              <action id="action:delete">allow</action>
            </actions>
          </group>
        </groups>
      </profile>
    </profiles>
  </user_rights>
  
  <!-- Add PersonalToken class configuration -->
  <classes>
    <class id="PersonalToken" _delta="must_exist">
      <scopes>
        <scope id="all" _delta="define">
          <oql><![CDATA[SELECT PersonalToken AS pt JOIN User AS u ON pt.user_id = u.id WHERE u.contactid = :current_contact_id]]></oql>
        </scope>
      </scopes>
    </class>
  </classes>

  <!-- Add Personal Tokens brick to portal module design -->
  <module_designs>
    <module_design id="itop-portal" xsi:type="portal" _delta="must_exist">
      <properties>
        <ui_version>v3</ui_version>
      </properties>
      <bricks>
        <brick id="personal-tokens" xsi:type="Combodo\iTop\Portal\Brick\ManageBrick" _delta="define">
          <active>true</active>
          <rank>
            <default>15</default>
          </rank>
          <width>12</width>
          <title>
            <default>Personal Tokens</default>
          </title>
          <decoration_class>
            <default>fas fa-key fa-2x</default>
          </decoration_class>
          <visible>
            <home>false</home>
            <navigation_menu>true</navigation_menu>
          </visible>
          <description>
            <default>Manage your personal API tokens for REST access</default>
          </description>
          <class>PersonalToken</class>
          <fields>
            <field id="application"/>
            <field id="scope"/>
            <field id="expiration_date"/>
            <field id="last_use_date"/>
            <field id="use_count"/>
          </fields>
          <actions>
            <action id="create_from_this" xsi:type="create_from_this">
              <class>PersonalToken</class>
              <icon_class>fas fa-plus</icon_class>
            </action>
            <action id="edit" xsi:type="edit">
              <icon_class>fas fa-edit</icon_class>
            </action>
            <action id="view" xsi:type="view">
              <icon_class>fas fa-eye</icon_class>
            </action>
          </actions>
          <opening_mode>edit</opening_mode>
          <data_loading>auto</data_loading>
        </brick>
      </bricks>
      <navigation_rules>
        <!-- Navigation rule for Personal Tokens brick -->
        <navigation_rule id="go-to-personal-tokens" xsi:type="go-to-manage-brick" _delta="define">
          <id>personal-tokens</id>
        </navigation_rule>
        <!-- Navigation rule for creating new tokens -->
        <navigation_rule id="go-to-personal-tokens-create" xsi:type="go-to-object" _delta="define">
          <mode>create</mode>
        </navigation_rule>
      </navigation_rules>
      <!-- Action rules for token creation -->
      <action_rules>
        <action_rule id="create-personal-token" _delta="define">
          <presets>
            <!-- Auto-set the user_id to current user -->
            <preset id="1">set(user_id, $current_user_id$)</preset>
          </presets>
        </action_rule>
      </action_rules>
      <!-- Forms for PersonalToken management -->
      <forms>
        <form id="personal-token-create" _delta="define">
          <class>PersonalToken</class>
          <fields/>
          <modes>
            <mode id="create"/>
            <mode id="edit"/>
          </modes>
        </form>
      </forms>
    </module_design>
  </module_designs>
</itop_design>
